# Create network using highly confident TE:KRAB-ZNF

In this script, we draw the cluster 1 and cluster 2 network in human. We also highlight the young pair of TE:KRAB-ZNF.

![](/figures/hmc1_869_age_network.png){width="649"}

![](/figures/networkImageC1/node_connectivity_barplot.jpg){width="597"}

Multivariate regression test (p\<0.001, node_typeTE) by combing the normalized degree and number of nodes.

![](/figures/networkImageC2/node_connectivity_barplot.jpg){width="602"}

```{r}
knitr::opts_chunk$set(echo=FALSE, message=FALSE, eval=FALSE)
```

```{r eval=FALSE}
library(dplyr)
library(RCy3)
library(netZooR)
library(ggplot2)
```

Load data

In cluster 1

```{r eval=FALSE}
hm_c1_sig <- read.csv("../tables/hmc1_sig_forNetwork.csv")

c1.node <- data.frame(
    id=c(unique(hm_c1_sig$geneName), unique(hm_c1_sig$teName))
)

# add age information
c1.link <- hm_c1_sig[,c(1,2,5,6)]
colnames(c1.link) <- c("source", "target", "coefficnet", "age")
```

```{r eval=FALSE}
# use condor to calculate the bipartite modularity
node_pair <- hm_c1_sig[,c(2,1,3)]
node_pair$coef <- abs(node_pair$coef)
c1_condor_obj <- createCondorObject(node_pair)
c1_condor_obj <- condorCluster(c1_condor_obj, cs.method = "LEC", project=F)

kznf_com <- c1_condor_obj$blue.memb
colnames(kznf_com)[1] <- "id"
te_com <- c1_condor_obj$red.memb
colnames(te_com)[1] <- "id"
df_com <- rbind(kznf_com, te_com)

c1.node <- c1.node %>%
    left_join(df_com, join_by(id==id))
colnames(c1.node)[2] <- "group"
c1.node$group <- as.character(c1.node$group)

createNetworkFromDataFrames(c1.node, c1.link)
```

```{r}

```

```{r}

```

```{r}
# we can do sth like this to calculate the degree
dfc1_condor %>% group_by(source, coefficnet, age) %>% 
    summarise(count=n()) %>% 
    arrange(desc(count)) %>% 
    filter(coefficnet=="negative" & age=="young")

dfc1_condor_preprocess <- dfc1_condor %>%
    mutate(link_class = paste0(coefficnet, "_", age)) %>%
    group_by(group.x, group.y, link_class) %>%
    summarise(count = n())
    
    

```

Calculate the properties of network

Create the adjacency matrix

```{r}
calculate_bipartite_connectivity <- function(adjacency_matrix, threshold_percent) {
  source_connectivity <- rowSums(adjacency_matrix)
  target_connectivity <- colSums(adjacency_matrix)
  
  # Create dataframe with node type (source or target), connectivity, and node name
  source_df <- data.frame(node_type = "KRAB-ZNF", 
                          connectivity = source_connectivity, 
                          node_name = rownames(adjacency_matrix))
  target_df <- data.frame(node_type = "TE", 
                          connectivity = target_connectivity, 
                          node_name = colnames(adjacency_matrix))
  
  # Combine dataframes
  connectivity_df <- rbind(source_df, target_df)
  
  # Calculate hubs based on threshold
  connectivity_df$is_hub <- FALSE
  hub_threshold <- quantile(connectivity_df$connectivity, 1 - threshold_percent/100)
  connectivity_df$is_hub <- ifelse(connectivity_df$connectivity >= hub_threshold, TRUE, FALSE)
  
  # Calculate gatekeepers
  connectivity_df$is_gatekeeper <- FALSE
  for (i in 1:nrow(connectivity_df)) {
    if (connectivity_df$node_type[i] == "KRAB-ZNF") {
      source_node <- connectivity_df$node_name[i]
      if (sum(adjacency_matrix[source_node,]) == 1) {
        connectivity_df$is_gatekeeper[i] <- TRUE
      }
    } else if (connectivity_df$node_type[i] == "TE") {
      target_node <- connectivity_df$node_name[i]
      if (sum(adjacency_matrix[,target_node]) == 1) {
        connectivity_df$is_gatekeeper[i] <- TRUE
      }
    }
  }
  
  rownames(connectivity_df) <- 1:nrow(connectivity_df)
  
  connectivity_df
}
```

```{r}
# cluster 1
adjmatrix_c1 <- table(dfc1_condor[,c(1,2)])
c1_connect <- calculate_bipartite_connectivity(adjmatrix_c1, 5)

c1_connect_count <- c1_connect %>% 
    group_by(node_type, connectivity) %>%
    summarise(count=n())

# because it is bipartite network, we need to normalized by KRAB-ZNF count and TE count
c1_k_num <- unique(hm_c1_sig$geneName) #101
c1_t_num <- unique(hm_c1_sig$teName) #253

c1_connect_count_normalize <- c1_connect_count %>%
    mutate(norm_degree = ifelse(node_type=="KRAB-ZNF", connectivity*1000/253, connectivity*1000/101))

# Perform multivariate regression
multivar_model <- lm(cbind(norm_degree, count) ~ node_type, data = c1_connect_count_normalize)
summary(multivar_model) #0.0002916 significant

g_c1_connect <- ggplot(c1_connect_count_normalize, aes(x=count, y=norm_degree, fill=node_type)) +
    geom_bar(stat="identity", position="dodge") +
    labs(x = "Number of nodes", y="Normalized Degree") +
    scale_fill_manual(values = c("KRAB-ZNF"="#C994C7", "TE"="#7BCCC4")) +
    theme_bw()

ggsave(g_c1_connect, file="../figures/networkImageC1/node_connectivity_barplot.jpg", 
       dpi=400,width=4,height=2.5)


```

## cluster 2

```{r}
hm_c2_sig <- read.csv("../tables/hmc2_sig_forNetwork.csv")

c2.node <- data.frame(
    id=c(unique(hm_c2_sig$geneName), unique(hm_c2_sig$teName))
)

# add age information
c2.link <- hm_c2_sig[,c(1,2,5,6)]
colnames(c2.link) <- c("source", "target", "coefficnet", "age")

# use condor to calculate the bipartite modularity
node_pair <- hm_c2_sig[,c(2,1,3)]
node_pair$coef <- abs(node_pair$coef)
c2_condor_obj <- createCondorObject(node_pair)
c2_condor_obj <- condorCluster(c2_condor_obj, cs.method = "LEC", project=F)

kznf_com <- c2_condor_obj$blue.memb
colnames(kznf_com)[1] <- "id"
te_com <- c2_condor_obj$red.memb
colnames(te_com)[1] <- "id"
df_com <- rbind(kznf_com, te_com)

c2.node <- c2.node %>%
    left_join(df_com, join_by(id==id))
colnames(c2.node)[2] <- "group"
c2.node$group <- as.character(c2.node$group)

createNetworkFromDataFrames(c2.node, c2.link)

```

```{r}
dfc2_condor <- c2.link %>%
    left_join(c2.node, join_by("source"=="id")) %>%
    left_join(c2.node, join_by("target"=="id"))

# example using create_condor_network function to extract subnetwork
create_condor_network(dfc2_condor, 2)
create_condor_network(dfc2_condor, 3)
create_condor_network(dfc2_condor, 5)
create_condor_network(dfc2_condor, 12)
```

```{r}
dfc2_condor_preprocess <- dfc2_condor %>%
    mutate(link_class = paste0(coefficnet, "_", age)) %>%
    group_by(group.x, group.y, link_class) %>%
    summarise(count = n())

# cluster 2
adjmatrix_c2 <- table(dfc2_condor[,c(1,2)])
c2_connect <- calculate_bipartite_connectivity(adjmatrix_c2, 5)

c2_connect_count <- c2_connect %>% 
    group_by(node_type, connectivity) %>%
    summarise(count=n())

# because it is bipartite network, we need to normalized by KRAB-ZNF count and TE count
c2_k_num <- unique(hm_c2_sig$geneName) #66
c2_t_num <- unique(hm_c2_sig$teName) #181

c2_connect_count_normalize <- c2_connect_count %>%
    mutate(norm_degree = ifelse(node_type=="KRAB-ZNF", connectivity*1000/66, connectivity*1000/181))

# Perform multivariate regression
multivar_model <- lm(cbind(norm_degree, count) ~ node_type, data = c2_connect_count_normalize)
summary(multivar_model) #0.00461 significant

g_c2_connect <- ggplot(c2_connect_count_normalize, aes(x=count, y=norm_degree, fill=node_type)) +
    geom_bar(stat="identity", position="dodge") +
    labs(x = "Number of nodes", y="Normalized Degree") +
    scale_fill_manual(values = c("KRAB-ZNF"="#C994C7", "TE"="#7BCCC4")) +
    theme_bw()

ggsave(g_c2_connect, file="../figures/networkImageC2/node_connectivity_barplot.jpg", 
       dpi=400,width=4,height=2.5)


```
